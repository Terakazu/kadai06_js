<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="css/sample.css">
    <title>ã‚¸ãƒ£ãƒ¼ãƒŠãƒªãƒ³ã‚°ã‚¢ãƒ—ãƒª</title>
    <style>
        body {
            background-image: url(img/background.png);
            font-family:Georgia, 'Times New Roman', Times, serif
            }
        </style>

</head>

<body>
    <header>
        <h1><i>Journaling Diary</i></h1>
    </header>

    <main>
        <!-- ã‚¤ãƒ³ãƒ—ãƒƒãƒˆç”»é¢ -->
        <!-- <button id="save2">SAVE</button>
        <button id="clear">CLEAR</button> -->
        <!-- <button id="load">èª­ã¿è¾¼ã¿</button> -->
        
            <div class="diary_area" id="diary_area">
                <div class="diary">
                    <h2>Diary</h2>
                    <p>ä»Šæ—¥ã¯ã©ã‚“ãª1æ—¥ã§ã—ãŸã‹ï¼Ÿ</p>
                    <button id="showView">éå»ã®æ—¥è¨˜ã¨ã‚¸ãƒ£ãƒ¼ãƒŠãƒªãƒ³ã‚°ã‚’è¦‹ã‚‹</button><br>
            
                <!-- æ—¥ä»˜ã‚’å…¥ã‚Œã‚‹ -->
                <label for="datepicker">select the date:</label>
                <input type="date" id="datepicker">
                <textarea id="text" cols="30" rows="10"></textarea><br>
                <input type="file" id="fileInput"> 
                <img id="preview" src="" style="display: none;"> 
                <button id="send">é€ä¿¡</button><br>
            </div>
            </div>

            <div class="output">
                <div id="output" style="display: none;">  
                <button id="return">æˆ»ã‚‹</button><br>
                </div>
            </div>
        

        <div class="emotion_area" id="emotion_area">
            <h2>How are you feeling?</h2>
            <p>è‡ªåˆ†ã®æ°—æŒã¡ã«è¿‘ã„ã‚‚ã®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚3ã¤ã¾ã§é¸æŠã§ãã¾ã™</p>
                
                <h3>selected emotion</h3><br>
                <label for="datepicker2">select the date:</label>
                <input type="date" id="datepicker2">
                <button id="save3">SAVE</button>
                <button id="clear2">CLEAR</button>
                <div class ="emotion_picks">
                    <div class="selected_emotions_container" id="selected_emotions1">æ„Ÿæƒ…1</div>
                    <div class="selected_emotions_container" id="selected_emotions2">æ„Ÿæƒ…2</div>
                    <div class="selected_emotions_container" id="selected_emotions3">æ„Ÿæƒ…3</div>
                    <!-- ã“ã“ã«é¸æŠã•ã‚ŒãŸæ„Ÿæƒ…ã‚’è¡¨ç¤º -->
                 </div>
            
            <div class="emotion2" id="emotion2">
            <ul class="orange">
                <li class="emotion" id="satisfaction">æº€è¶³</li>
                <li class="emotion" id="thankyou">æ„Ÿè¬</li>
                <li class="emotion" id="happy">å¬‰ã—ã„</li>
                <li class="emotion" id="wakuwaku">ãƒ¯ã‚¯ãƒ¯ã‚¯</li>
            </ul>
            <ul class="yellow">
                <li class="emotion" id="like">å¥½ã</li>
                <li class="emotion" id="impressed">æ„Ÿå¿ƒ</li>
                <li class="emotion" id="fun">é¢ç™½ã„</li>
                <li class="emotion" id="joy">æ¥½ã—ã„</li>

            </ul>
            <ul class="yellow-green">
                <li class="emotion" id="sukkiri">ã™ã£ãã‚Š</li>
                <li class="emotion" id="dokidoki">ãƒ‰ã‚­ãƒ‰ã‚­</li>
                <li class="emotion" id="peace">å®‰å¿ƒ</li>
                <li class="emotion" id="calm">ç©ã‚„ã‹</li>
            </ul>    
            <ul class="thin-green">
                <li class="emotion" id="usually">æ™®é€š</li>
                <li class="emotion" id="bore">é€€å±ˆ</li>
                <li class="emotion" id="moyamoya">ã‚‚ã‚„ã‚‚ã‚„</li>
                <li class="emotion" id="tension">ç·Šå¼µ</li>
            </ul>    
            <ul class="green">
                <li class="emotion" id="anxiety">ä¸å®‰</li>
                <li class="emotion" id="sad">æ‚²ã—ã„</li>
                <li class="emotion" id="tired">ç–²ã‚ŒãŸ</li>
                <li class="emotion" id="iraira">ã‚¤ãƒ©ã‚¤ãƒ©</li>
            </ul>    
            </div>
        </div>

        <div class="question_area" id="question_area">
            <div class="todayQuestion">
                <h2>Questions about you</h2>
                <button id="question">select questions<br>ä»–ã®å•ã„ã‚‚è¦‹ã‚‹</button>
            </div>
            <div id="select_question">Questionï¼š</div>
            <textarea id="answer"></textarea>
            <input type="file" id="fileInput2"> 
            <img id="preview2" src="" style="display: none;"> 
            <button id="answerSave">æŠ•ç¨¿</button>
            <button id="answerClear">å‰Šé™¤</button><br>
            <!-- <button id="allAnswers">See previous answers<br>ã“ã‚Œã¾ã§ã®å›ç­”ã‚’ã¿ã‚‹</button>
            <textarea id="pages"></textarea> -->
            </div>
        </div>

        <div style="position: relative;">
            <canvas id="myChart" width="400" height="200"></canvas>
            <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 50px; background-color: rgba(176, 196, 222, 0.3);display: none;"></div>
        </div>
    
    </main>
    <footer><small>Journaling Diary</small></footer>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get , child, update, remove, onChildAdded, onChildChanged, onChildRemoved,runTransaction } 
from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
import { getStorage, ref as storageRef ,uploadBytes,getDownloadURL, getBlob } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";



// ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’è¡¨ç¤º
$("#showView").on("click",function(){
    console.log("ã§ãã¾ã—ãŸ");

// Firebaseã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¦è¡¨ç¤ºã™ã‚‹å‡¦ç†
onChildAdded(dbRef, function(data) {
    const diary = data.val();
    const key = data.key;

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®HTMLè¦ç´ ã‚’ä½œæˆ
    let m = '<div id="' + key + '" class="day">' + diary.date + '</div>';
    let h = '<div id="' + key + '" class="post">';
    h += '<div class="mytext">';

        // ã‚³ãƒ¡ãƒ³ãƒˆãŒé•·ã„å ´åˆã¯ä¸€éƒ¨ã‚’è¡¨ç¤ºã—ã€çœç•¥è¨˜å·ã‚’è¿½åŠ 
        const maxCommentLength = 150; // è¡¨ç¤ºã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®æœ€å¤§æ–‡å­—æ•°
        const truncatedComment = diary.text.length > maxCommentLength ? diary.text.substring(0, maxCommentLength) + "..." : diary.text;
        h += '<span contentEditable="true" id="' + key + '_update">' + truncatedComment + '</span>';
    h += '<span class="remove" data-key="' + key + '">ğŸš®</span>';
    h += '<span class="update" data-key="' + key + '">ğŸ†™</span>';
    h += '</div>';

    // ç”»åƒãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç”»åƒã‚’è¿½åŠ 
    if (diary.imageURL) {
        h += '<img class="myimg" src="' + diary.imageURL + '">';
    }

    h += '</div>'; // è¦ªè¦ç´ ã®çµ‚äº†ã‚¿ã‚°

    // mã¨hã‚’1ã¤ã®è¦ç´ ã«ã¾ã¨ã‚ã‚‹
    const $combined = $(m + h);

    // æ—¥ä»˜ã‚’åŸºæº–ã«ã—ã¦æ™‚ç³»åˆ—ã«ä¸¦ã¹ã‚‹
    const $output = $("#output");
    const $existingDays = $output.children(".day");
    let inserted = false;
    $existingDays.each(function() {
        const existingDate = new Date($(this).text());
        const currentDate = new Date(diary.date);
        if (currentDate > existingDate) {
            $(this).before($combined);
            inserted = true;
            return false; // eachãƒ«ãƒ¼ãƒ—ã‹ã‚‰æŠœã‘ã‚‹
        }
    });

    if (!inserted) {
        $output.append($combined);
    }
})

// ãƒ€ã‚¤ã‚¢ãƒªãƒ¼ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
$("#diary_area").hide();
    // æ„Ÿæƒ…ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    $("#emotion_area").hide();
    // å•é¡Œã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    $("#question_area").hide();
    //ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’è¡¨ç¤º
    $("#output").show();
});

const app= initializeApp(firebaseConfig);
const db = getDatabase(app); 
const dbRef = ref(db,"diary");
const storage = getStorage(app);
const inputRef = document.querySelector("#fileInput");
const formRef = document.querySelector("#form");

// "fileInput" ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
$("#fileInput").on("change", async function() {
    // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
    const file = this.files[0];
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ãŸã‚ã®å‡¦ç†
    const reader = new FileReader();
    reader.onload = function(e) {
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®è¦ç´ ã«ç”»åƒã‚’è¡¨ç¤º
        $("#preview").attr("src", e.target.result);
    };
    reader.readAsDataURL(file);
    $("#preview").show();
});

const bucketName = "gs://commonapli.appspot.com"; // Firebase Storageã®ãƒã‚±ãƒƒãƒˆåã‚’è¨­å®š
const handleSubmit = async () => {
  const file = inputRef.files[0];
  if (!file) {
        console.log("No file selected.");
        return null; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯nullã‚’è¿”ã™
  }

  const ext = file.name.split(".").pop();
  const fileName = `${Date.now()}.${ext}`;
  const filePath = `images/${fileName}`;
  console.log(filePath);
  const fileRef = storageRef(storage, filePath);
  console.log(fileRef);
  await uploadBytes(fileRef, file);
  console.log("Uploaded a blob or file!");

  // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ãŸã¨ãã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¿”ã™
  return fileName;

};

const handleDownload = async () => {
  const fileName = await handleSubmit(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
  const fileRef = storageRef(storage, `images/${fileName}`);
  const url = await getDownloadURL(fileRef);
  console.log(url);


};


// é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
$("#send").on("click", async function(){

    // ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã¨åŒæ§˜ã«ã€ä½ç½®æƒ…å ±ã‚’å«ã‚ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    const fileName = await handleSubmit(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
    let imageURL = null;
    if (fileName) {
        const fileRef = storageRef(storage, `images/${fileName}`);
        imageURL = await getDownloadURL(fileRef);
    }
    const diary = {
        text: $("#text").val(),
        date: $("#datepicker").val(),
        imageURL: imageURL// imageURL ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« URL ã‚’è¿½åŠ 
    };
    const newPostRef = push(dbRef);
    set(newPostRef, diary); // ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ Realtime Database ã«ä¿å­˜

// Firebaseã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¦è¡¨ç¤ºã™ã‚‹å‡¦ç†
onChildAdded(dbRef, function(data) {
    const diary = data.val();
    const key = data.key;

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®HTMLè¦ç´ ã‚’ä½œæˆ
    let m = '<div id="' + key + '" class="day">' + diary.date + '</div>';
    let h = '<div id="' + key + '" class="post">';
    h += '<div class="mytext">';

        // ã‚³ãƒ¡ãƒ³ãƒˆãŒé•·ã„å ´åˆã¯ä¸€éƒ¨ã‚’è¡¨ç¤ºã—ã€çœç•¥è¨˜å·ã‚’è¿½åŠ 
        const maxCommentLength = 150; // è¡¨ç¤ºã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®æœ€å¤§æ–‡å­—æ•°
        const truncatedComment = diary.text.length > maxCommentLength ? diary.text.substring(0, maxCommentLength) + "..." : diary.text;
        h += '<span contentEditable="true" id="' + key + '_update">' + truncatedComment + '</span>';
    h += '<span class="remove" data-key="' + key + '">ğŸš®</span>';
    h += '<span class="update" data-key="' + key + '">ğŸ†™</span>';
    h += '</div>';

    // ç”»åƒãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç”»åƒã‚’è¿½åŠ 
    if (diary.imageURL) {
        h += '<img class="myimg" src="' + diary.imageURL + '">';
    }

    h += '</div>'; // è¦ªè¦ç´ ã®çµ‚äº†ã‚¿ã‚°

    // mã¨hã‚’1ã¤ã®è¦ç´ ã«ã¾ã¨ã‚ã‚‹
    const $combined = $(m + h);

    // æ—¥ä»˜ã‚’åŸºæº–ã«ã—ã¦æ™‚ç³»åˆ—ã«ä¸¦ã¹ã‚‹
    const $output = $("#output");
    const $existingDays = $output.children(".day");
    let inserted = false;
    $existingDays.each(function() {
        const existingDate = new Date($(this).text());
        const currentDate = new Date(diary.date);
        if (currentDate > existingDate) {
            $(this).before($combined);
            inserted = true;
            return false; // eachãƒ«ãƒ¼ãƒ—ã‹ã‚‰æŠœã‘ã‚‹
        }
    });

    if (!inserted) {
        $output.append($combined);
    }
     // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    $("#text").val("");
    $("#fileInput").val("");
    $("#preview").hide();

    // ãƒ€ã‚¤ã‚¢ãƒªãƒ¼ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    $("#diary_area").hide();
    // æ„Ÿæƒ…ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    $("#emotion_area").hide();
    // å•é¡Œã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    $("#question_area").hide();
    //ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’è¡¨ç¤º
    $("#output").show();
});
});




// å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
$("#output").on("click",".remove",function(){
  console.log("å‰Šé™¤ã—ã¾ã™");
  const key =$(this).attr("data-key");
  const remove_item =ref(db,"diary/"+key);
  console.log(remove_item);
  remove(remove_item); //Firebaseãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–¢æ•°
});

// æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
$("#output").on("click",".update",function(){
  console.log("æ›´æ–°ã—ã¾ã™");
  const key =$(this).attr("data-key");
  update(ref(db,"diary/"+key), {
      text:$("#"+key+'_update').html()
  });

  // å‰Šé™¤å‡¦ç†ãŒfirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼
onChildRemoved(dbRef,(data)=> {
  $("#"+data.key).remove();  //DOMæ“ä½œé–¢æ•°ï¼ˆå¯¾è±¡ã‚’å‰Šé™¤ï¼‰
})
});

// æ›´æ–°å‡¦ç†ãŒfirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼
onChildChanged(dbRef,(data)=>{
    const newText = data.val().text || ''; // æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ã€‚ãƒ†ã‚­ã‚¹ãƒˆãŒæœªå®šç¾©ã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã«ã™ã‚‹
    $("#"+data.key+'_update').html(newText); // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
    $("#"+data.key+'_update').fadeOut(800).fadeIn(800); // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆ
});

 
// ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ã§ãã‚‹new Dateã‚’æ ¼ç´
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const date = String(today.getDate()).padStart(2, '0');
  const todayString = `${year}-${month}-${date}`;
  document.querySelector('#datepicker').value = todayString;
});


// æ„Ÿæƒ…ã‚’é¸æŠã™ã‚‹
let selectedEmotionsIndex = 1; // é¸æŠã•ã‚ŒãŸè¦ç´ ã‚’æŒ¿å…¥ã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–ã™ã‚‹
// 1ï¼é¸æŠã™ã‚‹
     $(".emotion").on("click",function(){
        console.log("OK");
        const selectedItem = $(this).text();
    // é¸æŠã•ã‚ŒãŸè¦ç´ ã‚’è¡¨ç¤ºã™ã‚‹
    $(`#selected_emotions${selectedEmotionsIndex}`).text(selectedItem);
   // æ¬¡ã®é¸æŠã•ã‚ŒãŸè¦ç´ ã‚’æŒ¿å…¥ã™ã‚‹ãŸã‚ã«ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ã™ã‚‹
   selectedEmotionsIndex++;
// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒ3ã‚’è¶…ãˆãŸå ´åˆã¯1ã«æˆ»ã™
if (selectedEmotionsIndex > 3) {
    selectedEmotionsIndex = 1;
}
});

//æ„Ÿæƒ…ã®ã‚¹ã‚³ã‚¢
// 1.å„æ„Ÿæƒ…ã®ã‚¹ã‚³ã‚¢ã‚’å®šç¾©ã™ã‚‹
const emotionScores = {
    "æº€è¶³": 5,
    "æ„Ÿè¬": 5,
    "å¬‰ã—ã„": 5,
    "ãƒ¯ã‚¯ãƒ¯ã‚¯":5,
    "å¥½ã":3,
    "æ„Ÿå¿ƒ":3,
    "é¢ç™½ã„":3,
    "æ¥½ã—ã„":3,
    "ã™ã£ãã‚Š":1,
    "ãƒ‰ã‚­ãƒ‰ã‚­":1,
    "å®‰å¿ƒ":1,
    "ç©ã‚„ã‹":1,
    "æ™®é€š":-1,
    "é€€å±ˆ":-1,
    "ã‚‚ã‚„ã‚‚ã‚„":-1,
    "ç·Šå¼µ":-1,
    "ä¸å®‰":-3,
    "æ‚²ã—ã„":-3,
    "ç–²ã‚ŒãŸ":-3,
    "ã‚¤ãƒ©ã‚¤ãƒ©":-3,
};

// é¸æŠã•ã‚ŒãŸæ„Ÿæƒ…ã‹ã‚‰åˆè¨ˆã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
function calculateTotalScore(selectedEmotions) {
    let totalScore = 0;
    selectedEmotions.forEach(emotion => {
        totalScore += emotionScores[emotion];
    });
    return totalScore;
}

// ç¸¦è»¸ãŒã‚¹ã‚³ã‚¢ã€æ¨ªè»¸ãŒæ—¥ä»˜ã®ã‚°ãƒ©ãƒ•ã‚’ä½œã‚‹
// æ—¥ä»˜ã”ã¨ã®ã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
const scoresByDate = {};

const dbRef2 = ref(db,"emotions");
// SAVEãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†
    
    $("#save3").on("click", function() {
        console.log("OKOK");
        const selectedEmotions = [];
        console.log(selectedEmotions);
        for (let i = 1; i <= 3; i++) {
            const emotion = $(`#selected_emotions${i}`).text();
            if (emotion !== "æ„Ÿæƒ…1") {
                selectedEmotions.push(emotion);
            }
        }
        const currentDate = $("#datepicker2").val();
        console.log(currentDate);
        const totalScore = calculateTotalScore(selectedEmotions);
        // ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    const data = {
        date: currentDate,
        score: totalScore
    };

    // Firebase Realtime Databaseã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹
    const newPostRef = push(dbRef2);
    set(newPostRef, data);
}); 

// ãƒœã‚¿ãƒ³è¦ç´ ã‚’å–å¾—
const saveButton = document.getElementById('save3');

// ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ©ãƒ•ã«ã™ã‚‹
// ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
saveButton.addEventListener('click', () => {
// Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
get(dbRef2).then((snapshot) => {
    if (snapshot.exists()) {
        const data = snapshot.val();

        // ãƒ‡ãƒ¼ã‚¿ã‚’æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹
        const sortedData = Object.entries(data).sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB));
        console.log(sortedData);
        const dates = [];
        const scores = [];
        console.log(dates);
        console.log(scores);

       // æ—¥ä»˜ã¨ã‚¹ã‚³ã‚¢ã®é…åˆ—ã‚’ä½œæˆã™ã‚‹
sortedData.forEach(([key, entry]) => {
    dates.push(entry.date); // ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç›´æ¥æ—¥ä»˜ã‚’å–å¾—
    scores.push(entry.score);
});

        // Chart.jsã§ã‚°ãƒ©ãƒ•ã‚’æç”»ã™ã‚‹
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Score',
                    data: scores,
                    fill: true,
                    borderColor: 'rgba(54, 162, 235, 1)', // ç·šã®è‰²ã‚’é’ã«è¨­å®š
        backgroundColor: function(context) {
            // ã‚¹ã‚³ã‚¢ãŒ0æœªæº€ã®å ´åˆã¯èµ¤è‰²ã€0ä»¥ä¸Šã®å ´åˆã¯é’è‰²
            return context.dataset.data[context.dataIndex] < 0 ? 'rgba(255, 99, 132, 0.2)' : 'rgba(54, 162, 235, 0.2)';
        console.log(context.dataIndex);
        },
                    tension: 0.1,
                   
                }]
            },
    options: {
        plugins: {
            legend: {
                display: false // å‡¡ä¾‹ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            }
        },
                scales: {
                    x: [{ 
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'YYYY-MM-DD'
                            }
                        }
                    }],
                    y: {
                beginAtZero: true,
                gridLines: {
                    color: 'rgba(255, 0, 0, 0.5)' // èµ¤è‰²ã®ç·šã‚’å¼•ã
                    }
                }
            }
        }
        });
    } else {
        console.log("No data available");
    }
}).catch((error) => {
    console.error("Error getting data: ", error);
});

});
    



// å•ã„ã¨å›ç­”ã®å®šç¾©
const questions = [
    "äººç”Ÿã§æœ€ã‚‚ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ãŸæ™‚ã¯ã©ã‚“ãªæ™‚ã§ã™ã‹ï¼Ÿã¾ãŸãã‚Œã¯ãªãœã§ã™ã‹ï¼Ÿ",
    "ä»Šå¾Œã®äººç”Ÿã«ãŠã„ã¦ã€ä½•ãŒãªã‚“ã§ã‚‚ã‚„ã‚ŠãŸã„ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ",
    "ã‚ãªãŸãŒã¨ã¦ã‚‚é•·ãæ²¡é ­ã§ãã‚‹ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ",
    "æœ€è¿‘æ„Ÿå‹•ã—ãŸã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ",
    "æœ€å¾Œã«å¿ƒæºã•ã¶ã‚‰ã‚ŒãŸã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ",
    "ã‚ãªãŸã¯ã‚¹ãƒˆãƒ¬ã‚¹ãŒã‹ã‹ã£ãŸã¨ãã€ã©ã‚“ãªè¡Œå‹•ã‚’ã—ã¾ã™ã‹ï¼Ÿ",
    "è‡ªåˆ†ã®å¿ƒãŒæ¸©ã¾ã‚‹ã¨ãã¯ã©ã‚“ãªæ™‚ã§ã™ã‹ï¼Ÿ",
    "ã‚ãªãŸãŒæ±ºæ–­ã™ã‚‹ã¨ãã«å¤§äº‹ã«ã—ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ",
    "ã‚ãªãŸãŒé­…åŠ›ã«æ„Ÿã˜ã‚‹äººã¯ã©ã‚“ãªäººã§ã™ã‹ï¼Ÿ", 
    "ä»Šã€ã‚ãªãŸã®å‰ã«ã€Œã©ã“ã§ã‚‚ãƒ‰ã‚¢ã€ãŒç¾ã‚Œã¾ã—ãŸã€‚ã©ã“ã«è¡ŒããŸã„ã§ã™ã‹ï¼Ÿ",
];
    
// æœ€åˆã®ãƒšãƒ¼ã‚¸ã§å•ã„ã‚’å‡ºã—ã¦ãŠã
document.addEventListener('DOMContentLoaded', function() {
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ ãªå•ã„ã‚’é¸æŠã—ã¦è¡¨ç¤ºã™ã‚‹
    const r = Math.floor(Math.random() * questions.length); // å•ã„ã®æ•°ã«åˆã‚ã›ã¦ä¿®æ­£
    const selectedQuestion = questions[r];
    // const selectedAnswer = questionsAndAnswers[r].answer;
    $("#select_question").text(selectedQuestion); // ãƒ©ãƒ³ãƒ€ãƒ ãªå•ã„ã‚’è¡¨ç¤º
    // $("#answer").val(selectedAnswer); // å¯¾å¿œã™ã‚‹å›ç­”ã‚’è¡¨ç¤º
});


// ãƒ©ãƒ³ãƒ€ãƒ ã®å•ã„ã‚’å‡ºã™
$("#question").on("click", function() {
    const r = Math.floor(Math.random() * 10); // 0ã‹ã‚‰9ã¾ã§ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ•´æ•°ã‚’ç”Ÿæˆâ‡’ã“ã‚Œã ã¨1ï½10 const r = Math.ceil(Math.random() * 10);
    const selectedQuestion = questions[r]; // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã•ã‚ŒãŸå•ã„
    // const selectedAnswer = questionsAndAnswers[r].answer; // é¸æŠã•ã‚ŒãŸå•ã„ã«å¯¾å¿œã™ã‚‹å›ç­”
    $("#select_question").text(selectedQuestion); // å•ã„ã‚’è¡¨ç¤º

});

 // å•ã„ã®ç­”ãˆã‚’å‰Šé™¤ã™ã‚‹ã¨ã
 $("#answerClear").on("click", function () {
    alert("å‰Šé™¤ã—ã¾ã—ãŸ");
    localStorage.removeItem("answers");
    $("#answer").val("");
    $("#pages").val("");
});

//å•ã„ã®ã¨ã“ã‚ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
$("#fileInput2").on("change", async function() {
    // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
    const file = this.files[0];
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ãŸã‚ã®å‡¦ç†
    const reader = new FileReader();
    reader.onload = function(e) {
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®è¦ç´ ã«ç”»åƒã‚’è¡¨ç¤º
        $("#preview2").attr("src", e.target.result);
    };
    reader.readAsDataURL(file);
    $("#preview2").show();

const bucketName = "gs://commonapli.appspot.com"; // Firebase Storageã®ãƒã‚±ãƒƒãƒˆåã‚’è¨­å®š
const handleSubmit = async () => {
  const file = inputRef.files[0];
  if (!file) {
        console.log("No file selected.");
        return null; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯nullã‚’è¿”ã™
  }

  const ext = file.name.split(".").pop();
  const fileName = `${Date.now()}.${ext}`;
  const filePath = `images/${fileName}`;
  console.log(filePath);
  const fileRef = storageRef(storage, filePath);
  console.log(fileRef);
  await uploadBytes(fileRef, file);
  console.log("Uploaded a blob or file!");

  // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ãŸã¨ãã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¿”ã™
  return fileName;
}

const handleDownload = async () => {
  const fileName = await handleSubmit(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
  const fileRef = storageRef(storage, `images/${fileName}`);
  const url = await getDownloadURL(fileRef);
  console.log(url);
};
});

//å•ã„ã®ç­”ãˆã®ä¿å­˜
// ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹
const currentDate = new Date();

// å¹´ã€æœˆã€æ—¥ã‚’å–å¾—ã™ã‚‹
const year = currentDate.getFullYear();
const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚ã€+1ã™ã‚‹
const day = String(currentDate.getDate()).padStart(2, '0');

// ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ãŸæ—¥ä»˜ã‚’ä½œæˆã™ã‚‹ï¼ˆä¾‹ï¼š2024-03-19ï¼‰
const todayString = `${year}-${month}-${day}`;

$("#answerSave").on("click",async function(){
   // ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã¨åŒæ§˜ã«ã€ä½ç½®æƒ…å ±ã‚’å«ã‚ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
   const fileName = await handleSubmit(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
    let imageURL = null;
    if (fileName) {
                const fileRef = storageRef(storage, `images/${fileName}`);
                imageURL = await getDownloadURL(fileRef);
            }

    // è³ªå•ã¨å›ç­”ã‚’å–å¾—ã—ã¦é€£çµ
    const selectedQuestion = $("#select_question").text(); // è³ªå•ã‚’å–å¾—
    const selectedAnswer = $("#answer").val(); // å›ç­”ã‚’å–å¾—
    const text = "<div style='text-align: left;'>" + selectedQuestion + "<br>" + selectedAnswer + "<br><span style='color:red;'>ã‚¸ãƒ£ãƒ¼ãƒŠãƒªãƒ³ã‚°</span>"; // è³ªå•ã¨å›ç­”ã‚’é€£çµ

    const answer = {
        text: text,
        date: todayString,
        imageURL: imageURL// imageURL ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« URL ã‚’è¿½åŠ 
    };
    const newPostRef = push(dbRef);
    set(newPostRef, answer); // ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ Realtime Database ã«ä¿å­˜

// Firebaseã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¦è¡¨ç¤ºã™ã‚‹å‡¦ç†
onChildAdded(dbRef, function(data) {
    const answer = data.val();
    console.log(answer);
    const key =data.key;
    console.log(key);

     // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®HTMLè¦ç´ ã‚’ä½œæˆ
     let m = '<div id="' + key + '" class="day">' + answer.date + '</div>';
    let h = '<div id="' + key + '" class="post" style="display: flex;">';
        h = '<div id="'+key+'" class="post">';
        h += '<span contentEditable="true" id="'+key+'_update">'+answer.text+'</span>';
        h += '<span class="remove" data-key="'+key+'">ğŸš®</span>'
       h += '<span class="update" data-key="'+key+'">ğŸ†™</span>'
       h += '</p>';
    // ç”»åƒãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç”»åƒã‚’è¿½åŠ 
    if (answer.imageURL) {
        h += '<img class="myimg" src="' + answer.imageURL + '">';
    }

    h += '</div>'; // è¦ªè¦ç´ ã®çµ‚äº†ã‚¿ã‚°

    // mã¨hã‚’1ã¤ã®è¦ç´ ã«ã¾ã¨ã‚ã‚‹
    const $combined = $(m + h);

    // æ—¥ä»˜ã‚’åŸºæº–ã«ã—ã¦æ™‚ç³»åˆ—ã«ä¸¦ã¹ã‚‹
    const $output = $("#output");
    const $existingDays = $output.children(".day");
    let inserted = false;
    $existingDays.each(function() {
        const existingDate = new Date($(this).text());
        const currentDate = new Date(answer.date);
        if (currentDate > existingDate) {
            $(this).before($combined);
            inserted = true;
            return false; // eachãƒ«ãƒ¼ãƒ—ã‹ã‚‰æŠœã‘ã‚‹
        }
    });

    if (!inserted) {
        $output.append($combined);
    }
//     //å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
// $("#answer").val("");
 // ãƒ€ã‚¤ã‚¢ãƒªãƒ¼ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
 $("#diary_area").hide();
    // æ„Ÿæƒ…ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    $("#emotion_area").hide();
    // å•é¡Œã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    $("#question_area").hide();
    //ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’è¡¨ç¤º
    $("#output").show();
});
}); 

// æˆ»ã‚‹ãƒœã‚¿ãƒ³
$(document).on("click", "#return", function() {
    console.log("æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
    // ä»–ã®å‡¦ç†ã‚’ã“ã“ã«è¿½åŠ ã™ã‚‹

     //ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’éè¡¨ç¤º
     $("#output").hide();
    // ãƒ€ã‚¤ã‚¢ãƒªãƒ¼ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºã«ã™ã‚‹
    $("#diary_area").show();
    // æ„Ÿæƒ…ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºã«ã™ã‚‹
    $("#emotion_area").show();
    // å•é¡Œã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºã«ã™ã‚‹
    $("#question_area").show();
   
});


</script>
</body>

</html>